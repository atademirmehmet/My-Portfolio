# =============================================================
# GitLab CI/CD Pipeline - Portfolio Application
# =============================================================

stages:
  - build
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""
  # GitLab Container Registry
  FRONTEND_IMAGE: "$CI_REGISTRY_IMAGE/frontend"
  BACKEND_IMAGE: "$CI_REGISTRY_IMAGE/backend"
  # Versiyon etiketi
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"

# =============================================================
# BUILD STAGE
# =============================================================

build_frontend:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -t $FRONTEND_IMAGE:$IMAGE_TAG -t $FRONTEND_IMAGE:latest frontend
    - docker push $FRONTEND_IMAGE:$IMAGE_TAG
    - docker push $FRONTEND_IMAGE:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

build_backend:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -t $BACKEND_IMAGE:$IMAGE_TAG -t $BACKEND_IMAGE:latest backend
    - docker push $BACKEND_IMAGE:$IMAGE_TAG
    - docker push $BACKEND_IMAGE:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# =============================================================
# DEPLOY STAGE
# =============================================================

deploy_production:
  stage: deploy
  image: dtzar/helm-kubectl:latest
  script:
    # Kubeconfig ayarla
    - mkdir -p ~/.kube
    - echo "$KUBE_CONFIG" > ~/.kube/config
    - chmod 600 ~/.kube/config
    
    # 1. Namespace oluştur
    - kubectl create namespace portfolio --dry-run=client -o yaml | kubectl apply -f -
    
    # 2. GitLab Registry Secret oluştur
    - |
      kubectl create secret docker-registry gitlab-registry \
        --docker-server=$CI_REGISTRY \
        --docker-username=$K8S_DEPLOY_USER \
        --docker-password=$K8S_DEPLOY_PASS \
        -n portfolio --dry-run=client -o yaml | kubectl apply -f -
    
    # 3. Helm ile deploy
    - |
      helm upgrade --install portfolio ./helm/portfolio \
        -n portfolio \
        --set global.imagePullSecrets[0].name=gitlab-registry \
        --set frontend.image.repository=$FRONTEND_IMAGE \
        --set frontend.image.tag=$IMAGE_TAG \
        --set backend.image.repository=$BACKEND_IMAGE \
        --set backend.image.tag=$IMAGE_TAG
    
    # 4. Deployment durumunu kontrol et
    - kubectl rollout status deployment/portfolio-frontend -n portfolio
    - kubectl rollout status deployment/portfolio-backend -n portfolio
    
    # 5. Sonucu göster
    - echo "✅ Deployment tamamlandı!"
    - kubectl get pods -n portfolio
    - kubectl get svc -n portfolio
  environment:
    name: production
    url: https://mehmetatademir.com
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'